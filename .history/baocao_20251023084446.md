Chương II. Phân tích thiết kế

1. Tổng quan kiến trúc hệ thống

1.1 Mô tả tổng quan
Game Store là nền tảng thương mại điện tử chuyên biệt cho game digital, được xây dựng trên kiến trúc 3-tier hiện đại với tích hợp AI/ML. Hệ thống cung cấp trải nghiệm mua sắm cá nhân hóa thông qua thuật toán gợi ý thông minh, đồng thời đảm bảo quản lý toàn diện cho doanh nghiệp.

Mục tiêu hệ thống:
- Cung cấp nền tảng mua bán game digital an toàn, tiện lợi
- Cá nhân hóa trải nghiệm người dùng qua AI recommendation
- Tối ưu hóa quy trình thanh toán và quản lý giao dịch
- Hỗ trợ quản trị viên giám sát và phân tích kinh doanh hiệu quả
- Đảm bảo khả năng mở rộng và bảo trì dễ dàng

1.2 Kiến trúc tổng thể

Hệ thống áp dụng kiến trúc Client-Server với 3 tầng (3-tier architecture):

TIER 1 - PRESENTATION LAYER (Frontend):
- Công nghệ: React 18 + TypeScript + Material-UI
- Trách nhiệm:
  o Giao diện người dùng responsive (desktop/mobile/tablet)
  o Xử lý user interaction và validation phía client
  o Render dữ liệu từ backend
  o Quản lý state với React Context API
  o Routing với React Router DOM v6
- Components chính:
  o Customer Interface: Home, GameDetail, Cart, Profile, Library
  o Admin Dashboard: GameManagement, UserManagement, Analytics
  o Shared Components: Navbar, Footer, GameCard, Modal

TIER 2 - APPLICATION LAYER (Backend):
- Công nghệ: Node.js + Express + TypeScript
- Trách nhiệm:
  o RESTful API endpoints
  o Business logic processing
  o Authentication & Authorization (JWT)
  o Data validation
  o Integration với AI service
- Cấu trúc:
  o Controllers: Xử lý HTTP requests/responses
  o Services: Business logic
  o Middleware: Auth, Error handling, Logging
  o Routes: API routing

TIER 3 - DATA LAYER:
- Database chính: MySQL 8.0
  o Lưu trữ persistent data: users, games, transactions
  o ACID compliance đảm bảo tính toàn vẹn dữ liệu
  o Relationship management với foreign keys
- AI Service: Python Flask
  o Microservice riêng biệt cho AI/ML
  o Recommendation algorithms
  o Pre-computed models trong memory
- Tracking Database: SQLite
  o User interactions tracking
  o Temporal analysis (7-day recent activity)
  o Lightweight và fast

1.3 Luồng xử lý tổng quát

Luồng xử lý request cơ bản:
1. User tương tác → Frontend (React)
2. Frontend gửi HTTP request → Backend API (Express)
3. Backend xác thực JWT token → Middleware
4. Controller nhận request → Gọi Service
5. Service xử lý business logic → Truy vấn Database
6. Database trả kết quả → Service xử lý
7. Service trả data → Controller format response
8. Backend trả JSON → Frontend render UI

Luồng xử lý AI recommendation (đặc biệt):
1. Frontend request recommendations → Backend
2. Backend chuẩn bị data (games, users, interactions)
3. Backend gọi AI Service (Python Flask) qua HTTP
4. AI Service:
   - Load pre-computed models (SVD, similarity matrix)
   - Tính toán scores (SVD, Content, Demo, Keyword)
   - Apply dynamic weights
   - Adaptive boosting
5. AI Service trả recommendations → Backend
6. Backend transform data → Frontend
7. Frontend render game list

2. Phân tích Actor và Use Cases

2.1 Actors trong hệ thống

ACTOR 1: Guest (Khách vãng lai)
- Định nghĩa: Người dùng chưa đăng ký/đăng nhập
- Quyền hạn:
  o Xem danh sách game
  o Xem chi tiết game
  o Tìm kiếm game
  o Xem reviews
- Hạn chế: Không thể mua game, đánh giá, hoặc xem recommendations

ACTOR 2: Customer (Khách hàng)
- Định nghĩa: Người dùng đã đăng ký và đăng nhập
- Kế thừa: Tất cả quyền của Guest
- Quyền hạn bổ sung:
  o Quản lý tài khoản cá nhân
  o Mua game và thanh toán
  o Quản lý library (thư viện game đã mua)
  o Wishlist (danh sách yêu thích)
  o Đánh giá và review game
  o Nhận gợi ý cá nhân hóa
  o Xem lịch sử giao dịch
  o Nạp tiền vào tài khoản

ACTOR 3: Admin (Quản trị viên)
- Định nghĩa: Người quản lý hệ thống
- Quyền hạn đầy đủ:
  o Tất cả quyền của Customer
  o Quản lý game (CRUD operations)
  o Quản lý user (xem, khóa tài khoản)
  o Duyệt yêu cầu nạp tiền
  o Xem thống kê và báo cáo
  o Quản lý đánh giá
  o Cấu hình hệ thống

ACTOR 4: AI Service (Hệ thống con)
- Định nghĩa: Microservice xử lý AI/ML
- Chức năng:
  o Nhận request từ Backend
  o Tính toán recommendations
  o Trả kết quả về Backend
- Không tương tác trực tiếp với user

2.2 Use Cases chính

USE CASE 1: Đăng ký tài khoản
- Actor: Guest
- Mô tả: Người dùng tạo tài khoản mới trên hệ thống
- Preconditions: Người dùng chưa có tài khoản
- Main Flow:
  1. Guest truy cập trang đăng ký
  2. Nhập thông tin: username, email, password, age, gender
  3. Hệ thống validate dữ liệu (email unique, password strength)
  4. Hash password với bcrypt (salt rounds=10)
  5. Lưu vào database với role='Customer'
  6. Tạo số dư ban đầu = 0 VND
  7. Trả về thông báo thành công
- Postconditions: Tài khoản mới được tạo, user có thể đăng nhập
- Alternative Flow:
  o 3a. Email đã tồn tại → Hiển thị lỗi "Email already exists"
  o 3b. Password quá yếu → Yêu cầu password mạnh hơn

USE CASE 2: Đăng nhập
- Actor: Customer/Admin
- Mô tả: User đăng nhập vào hệ thống
- Preconditions: User đã có tài khoản
- Main Flow:
  1. User nhập email và password
  2. Backend verify credentials với bcrypt.compare()
  3. Nếu hợp lệ, generate JWT token (expires: 24h)
  4. Token chứa: user_id, email, role
  5. Trả token về frontend
  6. Frontend lưu token vào localStorage
  7. Set token vào Authorization header cho các request sau
- Postconditions: User được authenticated, có thể truy cập protected routes
- Alternative Flow:
  o 2a. Email không tồn tại → "Invalid credentials"
  o 2b. Password sai → "Invalid credentials"
  o 2c. Token expired → Yêu cầu login lại

USE CASE 3: Tìm kiếm game
- Actor: Guest/Customer
- Mô tả: User tìm kiếm game theo keyword
- Preconditions: Không
- Main Flow:
  1. User nhập keyword vào search box (VD: "hành động")
  2. Frontend gửi GET /games?search=hành động
  3. Backend query database:
     - Tìm trong name, description, genre
     - LIKE '%hành động%' (case-insensitive)
  4. Nếu user đã login:
     - Gọi AI Service với keyword
     - Expand query qua library.json
     - Keyword weight = 60%
     - Trả về personalized results
  5. Nếu guest:
     - Trả về matched games (no personalization)
  6. Frontend render kết quả
- Postconditions: User thấy danh sách game phù hợp

USE CASE 4: Xem chi tiết game
- Actor: Guest/Customer
- Mô tả: Xem thông tin đầy đủ về một game
- Main Flow:
  1. User click vào game card
  2. Frontend gửi GET /games/:id
  3. Backend query:
     - Game details (name, price, description, images)
     - Publisher, genres, platforms, languages
     - Specifications (CPU, GPU, RAM)
     - Average rating, total reviews
  4. Nếu user đã login:
     - Check purchased status
     - Check wishlist status
     - Increment view_count trong database
  5. Gọi AI Service để lấy 8 similar games
  6. Frontend render trang chi tiết
- Postconditions: User xem đầy đủ thông tin game

USE CASE 5: Mua game
- Actor: Customer
- Mô tả: Customer mua game bằng số dư tài khoản
- Preconditions: 
  - User đã login
  - Số dư ≥ giá game
  - Chưa mua game này
- Main Flow:
  1. User click "Buy Now" trên game detail
  2. Frontend hiển thị confirmation modal
  3. User xác nhận → POST /purchases
  4. Backend bắt đầu transaction:
     a. BEGIN TRANSACTION
     b. Check số dư >= giá game
     c. Check chưa mua game này
     d. Trừ số dư: balance -= price
     e. Insert vào purchase table
     f. Insert vào balance_history (type='PURCHASE')
     g. COMMIT TRANSACTION
  5. Trả về purchase record
  6. Frontend hiển thị thành công, redirect to library
- Postconditions: 
  - Game được thêm vào library
  - Số dư bị trừ
  - Lịch sử giao dịch được ghi lại
- Alternative Flow:
  o 4b. Số dư không đủ → ROLLBACK, hiển thị lỗi
  o 4c. Đã mua rồi → ROLLBACK, hiển thị lỗi
  o 4g. Lỗi database → ROLLBACK, hiển thị lỗi

USE CASE 6: Nạp tiền vào tài khoản
- Actor: Customer
- Mô tả: Customer yêu cầu nạp tiền qua chuyển khoản ngân hàng
- Main Flow:
  1. Customer truy cập trang nạp tiền
  2. Nhập số tiền muốn nạp (VD: 500,000 VND)
  3. Hệ thống hiển thị QR code và thông tin chuyển khoản:
     - Số tài khoản
     - Nội dung chuyển khoản: "USER_ID - USERNAME"
  4. Customer chuyển khoản qua banking app
  5. Upload ảnh chứng từ (screenshot)
  6. POST /balance/deposit
  7. Backend lưu:
     - Insert vào deposit_request table
     - Status = 'PENDING'
     - Lưu link ảnh
  8. Trả về thông báo "Đang chờ duyệt"
- Postconditions: Yêu cầu nạp tiền được tạo, chờ admin duyệt

USE CASE 7: Duyệt nạp tiền (Admin)
- Actor: Admin
- Preconditions: Có yêu cầu nạp tiền pending
- Main Flow:
  1. Admin vào trang "Deposit Requests"
  2. Xem danh sách các yêu cầu pending
  3. Click vào yêu cầu cụ thể
  4. Xem ảnh chứng từ
  5. Xác minh thông tin chuyển khoản
  6. Nếu hợp lệ → Click "Approve":
     a. BEGIN TRANSACTION
     b. UPDATE user SET balance = balance + amount
     c. INSERT balance_history (type='DEPOSIT')
     d. UPDATE deposit_request SET status='APPROVED'
     e. COMMIT
  7. Nếu không hợp lệ → Click "Reject":
     - UPDATE deposit_request SET status='REJECTED'
  8. Customer nhận notification
- Postconditions: Số dư được cập nhật hoặc yêu cầu bị từ chối

USE CASE 8: Nhận gợi ý game cá nhân hóa
- Actor: Customer
- Preconditions: User đã login
- Main Flow:
  1. User vào trang Home hoặc Profile
  2. Frontend gửi GET /recommendations?user_id=X&days=7
  3. Backend chuẩn bị data:
     - Query games từ MySQL (với genres, platforms, specs)
     - Query users với interactions (purchases, wishlist, views)
  4. Backend gọi AI Service:
     - POST http://localhost:5000/api/recommend
     - Body: {user_id, games, users, query, days, top_n}
  5. AI Service xử lý:
     a. Phát hiện cold start (user có lịch sử không?)
     b. Chọn weights phù hợp (4 trường hợp)
     c. Tính SVD score (collaborative filtering)
     d. Tính Content score (similarity với games đã thích)
     e. Tính Demographic score (từ similar users)
     f. Nếu có query → expand_query() và tính Keyword score
     g. Ensemble: final_score = weighted sum
     h. Adaptive boosting (match preferences)
     i. Sort và filter
  6. AI Service trả về top 10-20 games
  7. Backend transform và trả về frontend
  8. Frontend render game grid
- Postconditions: User thấy danh sách game được gợi ý

USE CASE 9: Đánh giá game
- Actor: Customer
- Preconditions: User đã mua game
- Main Flow:
  1. User vào game detail hoặc library
  2. Click "Rate this game"
  3. Chọn rating (1-5 sao)
  4. Viết review (optional)
  5. POST /reviews
  6. Backend validate:
     - User đã mua game chưa
     - Chưa review game này
  7. Insert vào review table
  8. Recalculate average_rating của game:
     - AVG(rating) từ tất cả reviews
     - UPDATE game SET average_rating = new_avg
  9. Tracking vào SQLite (for AI)
  10. Trả về success
- Postconditions: Review được lưu, rating được cập nhật

USE CASE 10: Quản lý game (Admin)
- Actor: Admin
- Main Flow - Thêm game:
  1. Admin click "Add New Game"
  2. Nhập thông tin:
     - Basic: name, description, price, release_date, image
     - Categories: genres, platforms, languages
     - Publisher
     - Specs: MIN và REC (CPU, GPU, RAM, capacity)
     - Mode, multiplayer, age_rating
  3. Upload hình ảnh
  4. POST /admin/games
  5. Backend transaction:
     - INSERT game
     - INSERT game_genre (many-to-many)
     - INSERT game_platform
     - INSERT game_language
     - INSERT specification (MIN và REC)
  6. Retrain AI models (nếu cần)
  7. Trả về success
- Postconditions: Game mới xuất hiện trên store

2. Các thành phần chính của hệ thống
2.1 Khách hàng (Customer)
Khách hàng là người dùng cuối của hệ thống, thực hiện các hoạt động như:
-	Tìm kiếm và xem thông tin chi tiết game:
o	Duyệt danh sách game theo thể loại, nền tảng, nhà phát hành
o	Xem thông tin chi tiết: mô tả, giá, hình ảnh
o	Đọc đánh giá và xếp hạng từ người dùng khác
o	Xem thông tin yêu cầu hệ thống (CPU, GPU, RAM, storage)
-	Đăng ký và quản lý tài khoản:
o	Đăng ký tài khoản mới với email và mật khẩu
o	Đăng nhập/đăng xuất hệ thống
o	Cập nhật thông tin cá nhân (tên, tuổi, giới tính)
o	Quản lý số dư tài khoản
-	Quản lý thư viện game cá nhân:
o	Thêm game vào wishlist để theo dõi
o	Xem lịch sử game đã xem
o	Quản lý danh sách game đã mua
o	Tải và cài đặt game đã mua
-	Giao dịch và thanh toán:
o	Nạp tiền vào tài khoản qua chuyển khoản ngân hàng
o	Mua game bằng số dư tài khoản
o	Xem lịch sử giao dịch và biến động số dư
o	Theo dõi trạng thái yêu cầu nạp tiền
-	Tương tác và đóng góp:
o	Đánh giá game đã mua (rating 1-5 sao)
o	Viết review chi tiết về trải nghiệm chơi game
o	Nhận gợi ý game phù hợp dựa trên sở thích cá nhân
2.2 Quản trị viên (Admin)
Quản trị viên là người quản lý và giám sát toàn bộ hệ thống, có quyền truy cập và thực hiện tất cả các chức năng quản lý như:
-	Quản lý game:
o	Thêm game mới vào hệ thống với đầy đủ thông tin
o	Chỉnh sửa thông tin game (giá, mô tả, hình ảnh)
o	Xóa game không còn kinh doanh
o	Quản lý thể loại game, nền tảng, nhà phát hành
o	Xem thống kê game bán chạy, đánh giá cao
-	Quản lý người dùng:
o	Xem danh sách tất cả người dùng
o	Theo dõi thông tin chi tiết từng người dùng
o	Quản lý số dư tài khoản người dùng
o	Xem thống kê: tổng số user, customer, admin
o	Phân quyền và quản lý vai trò
-	Quản lý giao dịch:
o	Xem tất cả giao dịch mua game
o	Theo dõi doanh thu theo thời gian
o	Xem thống kê tổng doanh thu, số lượng giao dịch
o	Xuất báo cáo tài chính
-	Quản lý nạp tiền:
o	Xem danh sách yêu cầu nạp tiền đang chờ duyệt
o	Duyệt hoặc từ chối yêu cầu nạp tiền
o	Xác minh thông tin chuyển khoản
o	Cập nhật số dư cho người dùng sau khi duyệt
-	Quản lý đánh giá:
o	Xem tất cả đánh giá và review từ người dùng
o	Kiểm duyệt và xóa review không phù hợp
o	Theo dõi rating trung bình của từng game
-	Thống kê và báo cáo:
o	Dashboard tổng quan với các chỉ số quan trọng
o	Biểu đồ doanh thu, số lượng user, giao dịch
o	Phân tích xu hướng mua game
o	Đánh giá hiệu quả kinh doanh
2.3 Tài khoản
Tài khoản là phần lưu trữ thông tin của người dùng trên hệ thống, bao gồm:
-	Thông tin cơ bản:
o	User ID (định danh duy nhất)
o	Username (tên đăng nhập)
o	Email (để xác thực và liên hệ)
o	Mật khẩu (được mã hóa bằng bcrypt)
o	Vai trò (Customer/Admin)
-	Thông tin mở rộng:
o	Tuổi (để phân tích và gợi ý phù hợp)
o	Giới tính (để cá nhân hóa trải nghiệm)
o	Số dư tài khoản (để mua game)
-	Quyền truy cập:
o	Customer: Truy cập các trang mua sắm, quản lý thông tin cá nhân
o	Admin: Truy cập đầy đủ tất cả trang quản trị
o	Phân quyền dựa trên JWT token
2.4 Sản phẩm Game
Sản phẩm game là các mặt hàng digital được admin đăng lên hệ thống để khách hàng có thể tìm kiếm, chọn lựa và mua. Mỗi game có các thuộc tính:
-	Thông tin cơ bản:
o	Game ID (mã định danh duy nhất)
o	Tên game
o	Mô tả chi tiết về gameplay, cốt truyện
o	Giá bán (VNĐ)
o	Hình ảnh đại diện
-	Phân loại:
o	Thể loại (Genre): Action, RPG, Strategy, Sports, Simulation, etc.
o	Nền tảng (Platform): Windows, macOS, Linux, PlayStation, Xbox
o	Chế độ chơi (Mode): Single-player, Multiplayer, Co-op
o	Nhà phát hành (Publisher)
o	Ngày phát hành
-	Yêu cầu hệ thống:
o	CPU tối thiểu và đề xuất
o	GPU tối thiểu và đề xuất
o	RAM yêu cầu
o	Dung lượng ổ cứng
o	Hệ điều hành hỗ trợ
-	Thống kê và đánh giá:
o	Rating trung bình (1-5 sao)
o	Số lượng đánh giá
o	Số lượt xem
o	Số lượng đã bán
-	Tính năng nâng cao:
o	Người dùng có thể sắp xếp game theo: giá, rating, ngày phát hành
o	Lọc game theo thể loại, nền tảng, khoảng giá
o	Tìm kiếm game theo tên
o	Xem game tương tự dựa trên thuật toán gợi ý
2.5 Hệ thống gợi ý thông minh (AI/ML Integration)

Hệ thống AI/ML được tích hợp như một microservice riêng biệt, cung cấp 3 loại gợi ý:

Loại 1: All-time Recommendations (Gợi ý dựa trên toàn bộ lịch sử)
- Input: user_id, days=null
- Phân tích: Toàn bộ lịch sử từ lúc đăng ký
- Use case: Trang chủ, "Recommended for You"
- Đặc điểm: Ổn định, phản ánh sở thích lâu dài

Loại 2: Recent 7-day Recommendations (Gợi ý dựa trên 7 ngày gần đây)
- Input: user_id, days=7
- Phân tích: Chỉ interactions trong 7 ngày vừa qua
- Use case: Profile page, "What's new for you"
- Đặc điểm: Dynamic, phản ánh xu hướng hiện tại

Loại 3: Similar Games (Gợi ý game tương tự)
- Input: game_id
- Phân tích: Content similarity với game cụ thể
- Use case: Game detail page, "You may also like"
- Đặc điểm: Context-aware, không phụ thuộc user

Các thuật toán sử dụng (4 phương pháp):

1. SVD Collaborative Filtering (45%/15%/70%/30%):
   - Phân tích ma trận user-item với SVD (k=2 factors)
   - Dự đoán rating user sẽ cho game chưa mua
   - Công thức: predicted_rating = U × Σ × V^T + user_mean
   - Tìm pattern ẩn trong hành vi user

2. Content-Based Filtering (35%/15%/0%/0%):
   - Xây dựng feature vector (1008 dimensions):
     + Text features: TF-IDF cho genre, publisher, platform (1000 dims)
     + Numeric features: rating, price, downloads, capacity, year, CPU, GPU, RAM (8 dims)
   - Tính cosine similarity giữa games
   - Gợi ý games tương tự với những gì user đã thích

3. Demographic Filtering (20%/10%/30%/10%):
   - Tìm users có age/gender tương tự
   - Demographic similarity = age_weight × gender_weight
   - Age difference: giảm 0.2 mỗi năm chênh lệch (max 5 tuổi)
   - Gender match: same=1.0, different=0.5
   - Gợi ý games mà similar users thích

4. Keyword-Based Filtering (0%/60%/0%/60%):
   - Expand query qua library.json (74 categories)
   - Map tiếng Việt → tiếng Anh + synonyms
   - Field weights: name (3.0×), genre (2.5×), description (2.0×)
   - Ưu tiên cao khi user tìm kiếm

Ensemble Method với Dynamic Weighting:
- TH1: User có lịch sử, KHÔNG keyword → 45% + 35% + 20% + 0%
- TH2: User có lịch sử, CÓ keyword → 15% + 15% + 10% + 60%
- TH3: Cold Start, KHÔNG keyword → 70% + 0% + 30% + 0%
- TH4: Cold Start, CÓ keyword → 30% + 0% + 10% + 60%
- Validation: sum(weights) = 1.0

Adaptive Boosting (7-day tracking):
- Phát hiện recent preferences của user
- Boost factor: Publisher (×1.2), Genre (×1.2), Platform (×1.2), Price (×1.2)
- Dynamic adjustment dựa trên user behavior:
  + Nếu user hay explore → giảm keyword weight
  + Nếu user có preference mạnh → tăng content weight

CPU/GPU Normalization System:
- cpu.json: 67 CPU models với benchmark scores (Intel, AMD)
- gpu.json: 80+ GPU models với benchmark scores (NVIDIA, AMD)
- Normalization: cpu_score/60000, gpu_score/40000
- Fallback mechanism cho models không có trong database

3. Database Schema (MySQL)

3.1 Bảng User (Người dùng)
Lưu trữ thông tin tài khoản người dùng
```
CREATE TABLE user (
  user_id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(100) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,    -- Hashed với bcrypt
  role ENUM('Customer', 'Admin') DEFAULT 'Customer',
  age INT,
  gender ENUM('Male', 'Female', 'Other'),
  balance DECIMAL(15,2) DEFAULT 0.00,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

Ràng buộc và index:
- PRIMARY KEY: user_id (auto increment)
- UNIQUE: email, username (tránh trùng lặp)
- NOT NULL: username, email, password
- INDEX: email (tăng tốc login query)
- CHECK: balance >= 0 (số dư không âm)

3.2 Bảng Game (Sản phẩm game)
Lưu trữ thông tin game
```
CREATE TABLE game (
  game_id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  price DECIMAL(15,2) NOT NULL,
  release_date DATE,
  image VARCHAR(500),
  downloads INT DEFAULT 0,
  mode ENUM('Single Player', 'Multiplayer', 'Co-op') DEFAULT 'Single Player',
  multiplayer BOOLEAN DEFAULT FALSE,
  capacity DECIMAL(10,2),           -- Dung lượng (GB)
  age_rating VARCHAR(50),           -- E, T, M, AO
  link_download VARCHAR(500),
  average_rating DECIMAL(3,2) DEFAULT 0.00,
  publisher_id INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (publisher_id) REFERENCES publisher(publisher_id)
);
```

Index:
- INDEX: name (tìm kiếm game)
- INDEX: price (filter theo giá)
- INDEX: average_rating (sort theo rating)
- INDEX: publisher_id (join với publisher)

3.3 Bảng Publisher (Nhà phát hành)
```
CREATE TABLE publisher (
  publisher_id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) UNIQUE NOT NULL
);
```

3.4 Bảng Genre (Thể loại game)
```
CREATE TABLE genre (
  genre_id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) UNIQUE NOT NULL  -- Action, RPG, Strategy, etc.
);
```

3.5 Bảng Platform (Nền tảng)
```
CREATE TABLE platform (
  platform_id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) UNIQUE NOT NULL  -- Windows, PlayStation, Xbox, etc.
);
```

3.6 Bảng Language (Ngôn ngữ)
```
CREATE TABLE language (
  language_id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) UNIQUE NOT NULL  -- English, Vietnamese, Japanese, etc.
);
```

3.7 Bảng Specification (Cấu hình yêu cầu)
```
CREATE TABLE specification (
  spec_id INT PRIMARY KEY AUTO_INCREMENT,
  game_id INT NOT NULL,
  type ENUM('MIN', 'REC') NOT NULL,   -- Minimum hoặc Recommended
  cpu VARCHAR(255),
  gpu VARCHAR(255),
  ram VARCHAR(50),                     -- VD: "16GB"
  storage VARCHAR(50),
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE
);
```

Giải thích:
- Mỗi game có 2 specs: MIN (tối thiểu) và REC (khuyến nghị)
- ON DELETE CASCADE: Xóa game → xóa specs tự động

3.8 Bảng Many-to-Many Relationships

game_genre (Game có nhiều genres):
```
CREATE TABLE game_genre (
  game_id INT NOT NULL,
  genre_id INT NOT NULL,
  PRIMARY KEY (game_id, genre_id),
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE,
  FOREIGN KEY (genre_id) REFERENCES genre(genre_id)
);
```

game_platform (Game hỗ trợ nhiều platforms):
```
CREATE TABLE game_platform (
  game_id INT NOT NULL,
  platform_id INT NOT NULL,
  PRIMARY KEY (game_id, platform_id),
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE,
  FOREIGN KEY (platform_id) REFERENCES platform(platform_id)
);
```

game_language (Game hỗ trợ nhiều ngôn ngữ):
```
CREATE TABLE game_language (
  game_id INT NOT NULL,
  language_id INT NOT NULL,
  PRIMARY KEY (game_id, language_id),
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE,
  FOREIGN KEY (language_id) REFERENCES language(language_id)
);
```

3.9 Bảng Purchase (Giao dịch mua game)
```
CREATE TABLE purchase (
  purchase_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  game_id INT NOT NULL,
  purchase_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  price_paid DECIMAL(15,2) NOT NULL,
  UNIQUE KEY unique_purchase (user_id, game_id),  -- Mỗi user chỉ mua 1 lần
  FOREIGN KEY (user_id) REFERENCES user(user_id),
  FOREIGN KEY (game_id) REFERENCES game(game_id)
);
```

Ràng buộc:
- UNIQUE(user_id, game_id): Không mua trùng game
- price_paid: Lưu giá tại thời điểm mua (vì giá có thể thay đổi)

3.10 Bảng Wishlist (Danh sách yêu thích)
```
CREATE TABLE wishlist (
  wishlist_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  game_id INT NOT NULL,
  added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_wishlist (user_id, game_id),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE
);
```

3.11 Bảng Review (Đánh giá game)
```
CREATE TABLE review (
  review_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  game_id INT NOT NULL,
  rating INT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,
  review_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_review (user_id, game_id),  -- Mỗi user review 1 lần
  FOREIGN KEY (user_id) REFERENCES user(user_id),
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE
);
```

Trigger tự động cập nhật average_rating:
```sql
DELIMITER //
CREATE TRIGGER update_average_rating_after_review
AFTER INSERT ON review
FOR EACH ROW
BEGIN
  UPDATE game 
  SET average_rating = (
    SELECT AVG(rating) FROM review WHERE game_id = NEW.game_id
  )
  WHERE game_id = NEW.game_id;
END //
DELIMITER ;
```

3.12 Bảng View (Lịch sử xem game)
```
CREATE TABLE view (
  view_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  game_id INT NOT NULL,
  view_count INT DEFAULT 1,
  last_viewed TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY unique_view (user_id, game_id),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (game_id) REFERENCES game(game_id) ON DELETE CASCADE
);
```

Xử lý view_count:
- Nếu user xem lần đầu → INSERT view_count=1
- Nếu user xem lại → UPDATE view_count = view_count + 1
- ON DUPLICATE KEY UPDATE view_count = view_count + 1

3.13 Bảng Balance_History (Lịch sử biến động số dư)
```
CREATE TABLE balance_history (
  history_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  amount DECIMAL(15,2) NOT NULL,
  type ENUM('DEPOSIT', 'PURCHASE') NOT NULL,
  balance_before DECIMAL(15,2) NOT NULL,
  balance_after DECIMAL(15,2) NOT NULL,
  description VARCHAR(500),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES user(user_id)
);
```

Giải thích:
- DEPOSIT: Nạp tiền vào tài khoản (amount > 0)
- PURCHASE: Mua game (amount < 0)
- balance_before/after: Audit trail đầy đủ

3.14 Bảng Deposit_Request (Yêu cầu nạp tiền)
```
CREATE TABLE deposit_request (
  request_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  amount DECIMAL(15,2) NOT NULL,
  status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'PENDING',
  proof_image VARCHAR(500),           -- Link ảnh chứng từ
  requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  processed_at TIMESTAMP NULL,
  admin_note TEXT,
  FOREIGN KEY (user_id) REFERENCES user(user_id)
);
```

Index:
- INDEX: status (filter các request pending)
- INDEX: user_id (xem lịch sử request của user)

3.15 Relationships và Constraints

Primary Keys:
- Tất cả bảng có PRIMARY KEY auto increment
- Đảm bảo uniqueness và performance

Foreign Keys:
- Tất cả relationships sử dụng FOREIGN KEY
- ON DELETE CASCADE cho dependent data
- ON DELETE RESTRICT cho important relationships

Unique Constraints:
- user: email, username (tránh duplicate accounts)
- purchase: (user_id, game_id) (không mua trùng)
- wishlist: (user_id, game_id) (không thêm trùng)
- review: (user_id, game_id) (chỉ review 1 lần)

Check Constraints:
- review.rating: BETWEEN 1 AND 5
- user.balance: >= 0
- deposit_request.amount: > 0

Indexes để tối ưu performance:
- user(email): Tăng tốc login
- game(name): Tăng tốc search
- purchase(user_id): Lấy library của user
- review(game_id): Tính average rating
- balance_history(user_id): Xem lịch sử giao dịch

4. API Endpoints

4.1 Authentication APIs
```
POST /api/auth/register
- Body: {username, email, password, age, gender}
- Response: {success, message, user}
- Status: 201 Created

POST /api/auth/login
- Body: {email, password}
- Response: {success, token, user}
- Status: 200 OK

GET /api/auth/me
- Headers: Authorization: Bearer <token>
- Response: {user}
- Status: 200 OK
```

4.2 Game APIs
```
GET /api/games
- Query: ?search=keyword&genre=Action&platform=Windows&sort=price&order=asc
- Response: {games[], total}
- Status: 200 OK

GET /api/games/:id
- Response: {game, genres[], platforms[], specs[], reviews[]}
- Status: 200 OK
- Side effect: Increment view_count nếu user đã login

POST /api/games (Admin only)
- Headers: Authorization: Bearer <admin_token>
- Body: {name, description, price, publisher_id, genres[], platforms[], ...}
- Response: {success, game}
- Status: 201 Created

PUT /api/games/:id (Admin only)
- Body: {partial game data}
- Response: {success, game}
- Status: 200 OK

DELETE /api/games/:id (Admin only)
- Response: {success, message}
- Status: 200 OK
```

4.3 Recommendation APIs
```
GET /api/recommendations
- Query: ?user_id=1&query=hành động&days=7
- Description: Lấy AI recommendations cho user
- Flow:
  1. Prepare games và users data từ MySQL
  2. Call AI Service: POST http://localhost:5000/api/recommend
  3. Transform response
- Response: {success, games[], total, keyword}
- Status: 200 OK

GET /api/similar-games/:gameId
- Description: Lấy games tương tự với game cụ thể
- Flow:
  1. Prepare games data
  2. Call AI Service: POST http://localhost:5000/api/similar-games
- Response: {success, similar_games[], total}
- Status: 200 OK
```

4.4 Purchase APIs
```
POST /api/purchases
- Headers: Authorization: Bearer <token>
- Body: {game_id}
- Description: Mua game bằng số dư tài khoản
- Flow:
  1. Verify JWT token
  2. START TRANSACTION
  3. Check balance >= game.price
  4. Check not purchased yet
  5. Deduct balance
  6. Insert purchase
  7. Insert balance_history
  8. COMMIT TRANSACTION
- Response: {success, purchase, new_balance}
- Status: 201 Created
- Errors:
  o 400: Insufficient balance
  o 409: Already purchased
  o 500: Transaction failed

GET /api/purchases/library
- Headers: Authorization: Bearer <token>
- Description: Lấy danh sách game đã mua
- Response: {games[]}
- Status: 200 OK
```

4.5 Balance APIs
```
GET /api/balance
- Headers: Authorization: Bearer <token>
- Response: {balance, history[]}
- Status: 200 OK

POST /api/balance/deposit
- Headers: Authorization: Bearer <token>
- Body: {amount, proof_image}
- Description: Yêu cầu nạp tiền
- Flow:
  1. Validate amount > 0
  2. Upload proof_image to server
  3. Insert deposit_request (status=PENDING)
- Response: {success, request_id}
- Status: 201 Created

GET /api/balance/deposit-requests (Admin)
- Query: ?status=PENDING
- Response: {requests[]}
- Status: 200 OK

PUT /api/balance/deposit-requests/:id/approve (Admin)
- Description: Duyệt yêu cầu nạp tiền
- Flow:
  1. START TRANSACTION
  2. Get deposit_request
  3. Update user.balance += amount
  4. Insert balance_history (type=DEPOSIT)
  5. Update deposit_request.status = APPROVED
  6. COMMIT TRANSACTION
- Response: {success}
- Status: 200 OK
```

4.6 Review APIs
```
POST /api/reviews
- Headers: Authorization: Bearer <token>
- Body: {game_id, rating, comment}
- Preconditions: User đã mua game, chưa review
- Flow:
  1. Verify user purchased game
  2. Insert review
  3. Recalculate game.average_rating
  4. Track to SQLite for AI
- Response: {success, review}
- Status: 201 Created

GET /api/reviews/game/:gameId
- Response: {reviews[], average_rating}
- Status: 200 OK
```

4.7 Wishlist APIs
```
POST /api/wishlist
- Body: {game_id}
- Response: {success}
- Status: 201 Created

DELETE /api/wishlist/:gameId
- Response: {success}
- Status: 200 OK

GET /api/wishlist
- Response: {games[]}
- Status: 200 OK
```

4.8 Admin Statistics APIs
```
GET /api/admin/stats/overview
- Response: {
    total_users,
    total_games,
    total_purchases,
    total_revenue,
    revenue_this_month,
    top_selling_games[]
  }
- Status: 200 OK

GET /api/admin/stats/revenue
- Query: ?from=2024-01-01&to=2024-12-31
- Response: {daily_revenue[], total}
- Status: 200 OK
```

5. Luồng xử lý nghiệp vụ chi tiết

5.1 Luồng mua game (Purchase Flow)

Sequence Diagram:
```
Customer → Frontend: Click "Buy Game"
Frontend → Frontend: Show confirmation modal
Customer → Frontend: Confirm purchase
Frontend → Backend: POST /api/purchases {game_id}
Backend → Middleware: Verify JWT token
Middleware → Backend: User authenticated
Backend → MySQL: BEGIN TRANSACTION
Backend → MySQL: SELECT balance FROM user WHERE user_id=?
MySQL → Backend: balance = 1,000,000
Backend → MySQL: SELECT price FROM game WHERE game_id=?
MySQL → Backend: price = 500,000
Backend → Backend: Check balance >= price ✓
Backend → MySQL: SELECT * FROM purchase WHERE user_id=? AND game_id=?
MySQL → Backend: NULL (chưa mua)
Backend → MySQL: UPDATE user SET balance = 500,000
Backend → MySQL: INSERT purchase (user_id, game_id, price_paid)
Backend → MySQL: INSERT balance_history (PURCHASE, -500000)
Backend → MySQL: COMMIT TRANSACTION
MySQL → Backend: Transaction success
Backend → Frontend: {success: true, new_balance: 500000}
Frontend → Customer: Show success message
Frontend → Frontend: Redirect to /library
```

Error Handling:
```
Scenario 1: Số dư không đủ
- Backend check: 300,000 < 500,000
- Action: ROLLBACK TRANSACTION
- Response: {success: false, error: "Insufficient balance"}
- Frontend: Show error modal "Bạn cần nạp thêm 200,000 VND"

Scenario 2: Đã mua rồi
- MySQL return: purchase record exists
- Action: ROLLBACK TRANSACTION
- Response: {success: false, error: "Already purchased"}
- Frontend: Redirect to /library

Scenario 3: Connection lost
- MySQL throw error
- Action: AUTO ROLLBACK
- Response: {success: false, error: "Transaction failed"}
- Frontend: Show "Vui lòng thử lại"
```

5.2 Luồng AI Recommendation (Recommendation Flow)

Sequence Diagram:
```
Customer → Frontend: Truy cập trang Home
Frontend → Backend: GET /api/recommendations?user_id=1&days=7
Backend → MySQL: Query ALL games with details
MySQL → Backend: 150 games với genres, platforms, specs
Backend → MySQL: Query ALL users with interactions
MySQL → Backend: 50 users với purchases, wishlist, views
Backend → AI Service: POST /api/recommend
  Body: {
    user_id: 1,
    games: [150 games],
    users: [50 users],
    query: "",
    days: 7,
    top_n: 20
  }
AI Service → AI Service: Load library.json (keyword_library)
AI Service → AI Service: Check cold start
  - Get user interactions
  - If empty → is_cold_start = True
AI Service → AI Service: Choose weights
  - Cold start + no keyword → {SVD:70%, Content:0%, Demo:30%, Keyword:0%}
AI Service → AI Service: Calculate SVD scores
  - Use pre-computed SVD model (k=2)
  - predicted_ratings = U × Σ × V^T + user_mean
AI Service → AI Service: Calculate Content scores
  - Get games user interacted
  - Compute similarity với all games
  - Use content_similarity_matrix
AI Service → AI Service: Calculate Demographic scores
  - Find similar users (age/gender)
  - Get games those users liked
AI Service → AI Service: Calculate Keyword scores
  - expand_query(query) if query exists
  - get_keyword_score(game, expanded_query)
AI Service → AI Service: Ensemble scores
  - final_score = SVD×0.70 + Content×0.00 + Demo×0.30 + Keyword×0.00
AI Service → AI Service: Adaptive boosting
  - Analyze user preferences (recent 7 days)
  - Boost if match: publisher×1.2, genre×1.2, platform×1.2
AI Service → AI Service: Filter and sort
  - Remove purchased games
  - Remove wishlist games
  - Sort by final_score DESC
  - Take top 20
AI Service → Backend: {success: true, games: [20 recommendations]}
Backend → Backend: Transform data format
Backend → Frontend: {success: true, games: [...], total: 20}
Frontend → Customer: Render game grid với scores
```

5.3 Luồng Keyword Search với AI

Sequence Diagram:
```
Customer → Frontend: Nhập "hành động" vào search box
Frontend → Backend: GET /recommendations?user_id=1&query=hành%20động
Backend → AI Service: POST /api/recommend {query: "hành động"}
AI Service → AI Service: expand_query("hành động")
  - Load library.json
  - Find "hành động" in "Action" synonyms
  - Result: "hành động action"
AI Service → AI Service: Split keywords
  - ["hành", "động", "action"]
AI Service → AI Service: For each game, calculate keyword_score
  - Search in name (×3.0)
  - Search in genre (×2.5)
  - Search in description (×2.0)
  - Example: "Call of Duty"
    + name: no match → 0
    + genre: ["Action"] → match "action" → +2.5
    + description: "intense action game" → match "action" → +2.0
    + Total: 4.5 → normalized: min(4.5/10, 1.0) = 0.45
AI Service → AI Service: Choose weights với keyword
  - {SVD:15%, Content:15%, Demo:10%, Keyword:60%}
AI Service → AI Service: Ensemble
  - final_score = 0.15×svd + 0.15×content + 0.10×demo + 0.60×keyword
  - Example: final = 0.15×0.6 + 0.15×0.4 + 0.10×0.5 + 0.60×0.45
           = 0.09 + 0.06 + 0.05 + 0.27 = 0.47
AI Service → Backend: Top 20 games sorted by keyword relevance
Backend → Frontend: {games: [...]}
Frontend → Customer: Show results "Tìm thấy 20 games với 'hành động'"
```

6. Công nghệ sử dụng

6.1 Frontend Stack
- React 18.2: UI library
- TypeScript 5.0: Type safety
- Material-UI (MUI) 5.14: Component library
- React Router DOM v6: Client-side routing
- Axios: HTTP client
- Vite: Build tool (fast HMR)

6.2 Backend Stack
- Node.js 18: Runtime environment
- Express 4.18: Web framework
- TypeScript 5.0: Type safety
- MySQL2: Database driver
- bcrypt: Password hashing
- jsonwebtoken: JWT authentication
- CORS: Cross-origin resource sharing
- dotenv: Environment variables

6.3 AI/ML Stack
- Python 3.10: Programming language
- Flask 2.3: Microservice framework
- NumPy: Numerical computation
- Pandas: Data manipulation
- SciPy: SVD computation
- scikit-learn: TF-IDF, cosine similarity
- SQLite3: Interaction tracking
- Matplotlib: Visualization (charts)

6.4 Database
- MySQL 8.0: Main database (persistent data)
- SQLite: Tracking database (temporal analysis)

6.5 Development Tools
- Git: Version control
- npm/pip: Package managers
- VS Code: IDE
- Postman: API testing

7. Các yêu cầu phi chức năng
3.1 Hiệu năng
-	Thời gian tải trang không quá 3 giây
-	Xử lý giao dịch mua game trong vòng 1 giây
-	Hỗ trợ tối thiểu 1000 người dùng đồng thời
3.2 Bảo mật
-	Xác thực người dùng bằng JWT token
-	HTTPS cho tất cả giao dịch
-	Bảo vệ chống SQL injection và XSS attacks
-	Session timeout sau 24 giờ không hoạt động
3.3 Khả năng sử dụng
-	Giao diện thân thiện, trực quan với Material-UI
-	Responsive design hoạt động tốt trên mọi thiết bị
-	Thông báo rõ ràng cho mọi thao tác
-	Hướng dẫn sử dụng dễ hiểu
-	Hỗ trợ người dùng mới làm quen nhanh
3.4 Độ tin cậy
-	Hệ thống hoạt động ổn định 99.9% thời gian
-	Backup dữ liệu định kỳ
-	Xử lý lỗi gracefully với thông báo thân thiện
-	Rollback transaction khi gặp lỗi
3.5 Khả năng mở rộng
-	Kiến trúc modular dễ dàng thêm tính năng mới
-	Database được thiết kế normalized có thể scale
-	API RESTful chuẩn hóa
-	Dễ dàng tích hợp với hệ thống thanh toán khác
-	Có thể mở rộng lên microservices trong tương lai
3.6 Khả năng bảo trì
-	Code được tổ chức rõ ràng theo kiến trúc MVC
-	Code được tổ chức rõ ràng theo kiến trúc MVC
-	Comment và documentation đầy đủ
-	TypeScript giúp detect lỗi sớm
-	Test coverage đầy đủ các chức năng quan trọng
-	Git version control để quản lý source code
